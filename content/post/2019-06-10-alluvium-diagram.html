---
title: alluvial diagram å†²ç§¯å›¾
author: Jackie
date: '2019-06-10'
slug: alluvial-diagram
categories:
  - R
tags:
  - ggplot2
  - R
  - Viz
disable_comments: no
show_toc: yes
output:
  blogdown::html_page:
    toc: yes
---


<div id="TOC">
<ul>
<li><a href="#quick-start-with-alluvial">Quick Start with alluvial</a></li>
<li><a href="#æ›´å¤šç”¨æ³•å’Œè‡ªå®šä¹‰">æ›´å¤šç”¨æ³•å’Œè‡ªå®šä¹‰</a><ul>
<li><a href="#éšè—">éšè—</a></li>
<li><a href="#æ”¹å˜å±‚æ¬¡">æ”¹å˜å±‚æ¬¡</a></li>
</ul></li>
<li><a href="#ggplot2-ggalluvial">ggplot2: ggalluvial</a><ul>
<li><a href="#å®½æ•°æ®æ ¼å¼">å®½æ•°æ®æ ¼å¼</a></li>
<li><a href="#é•¿æ•°æ®æ ¼å¼">é•¿æ•°æ®æ ¼å¼</a></li>
</ul></li>
</ul>
</div>

<div class="figure">
<img src="/post/2019-06-10-alluvium-diagram_files/figure-html/0.geom_alluvium.png" alt="geom_alluvium" />
<p class="caption">geom_alluvium</p>
</div>
<p>æœ€è¿‘çœ‹æ–‡çŒ®çœ‹åˆ°ä¸€ç§æ–°çš„æ•°æ®å¯è§†åŒ–å›¾ï¼ŒAlluvia å›¾ï¼Œä¸­æ–‡åº”è¯¥æ˜¯å†²ç§¯å›¾ï¼Ÿä¸çŸ¥é“ã€‚è¿™ç§å›¾å½¢ç”¨æ¥å±•ç¤ºåˆ†ç±»æ•°æ®ï¼Œå°¤å…¶æ˜¯å¤šä¸ªåˆ†ç±»æ•°æ®ä»¥åŠ Logistic å›å½’é‡Œï¼Œç¾è§‚è€Œä¸”ç›´è§‚ï¼Œæ‰€ä»¥å†³å®šçœ‹ä¸€ä¸‹ã€‚</p>
<p>å‚è€ƒä¸»è¦æ˜¯ <a href="https://cran.r-project.org/web/packages/alluvial/vignettes/alluvial.html"><strong>alluvial</strong></a> å’Œ <a href="https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html"><strong>ggalluvial</strong></a> çš„æ–‡æ¡£ ï¼Œæœ‰åˆ æ”¹ã€‚</p>
<p><strong>alluvial</strong> æ˜¯ä¼ ç»Ÿçš„ Alluvia å›¾ä½œå›¾åŒ…ï¼Œè€Œ <strong>ggalluvial</strong> ä»åå­—å°±èƒ½çœ‹å‡ºæ¥æ˜¯ <strong>ggplot2</strong> åŒ…ã€‚</p>
<p>ä¸»è¦çœ‹ alluvial çš„ç”¨æ³•ï¼Œå› ä¸ºå®ƒå¯¹åº” base ä½œå›¾ç³»ç»Ÿï¼Œæ‰€ä»¥è¯­æ³•ç®€å•ç›´æ¥ã€‚<strong>alluvial</strong> æ¥å—çš„æ•°æ®å½¢å¼æ˜¯å®½æ•°æ®ï¼Œå³æ•´ç†å¥½çš„é¢‘æ•°è¡¨å½¢å¼ã€‚<strong>ggalluvial</strong> æ˜¯ <strong>ggplot2</strong> è¯­æ³•ç³»ç»Ÿï¼Œè‡ªå®šä¹‰ç¨‹åº¦é«˜ï¼Œç”¨æ³•ä¸°å¯Œã€‚<strong>ggalluvial</strong> æ¥å—é•¿æ•°æ®å’Œå®½æ•°æ®ä¸¤ç§å½¢å¼ï¼ŒåŒæ—¶ä¸ºäº†ä¿æŒ <em>tidyverse</em> è¯­æ³•ä¸€è‡´ï¼Œä¸æ”¯æŒé¢‘æ•°è¡¨ğŸ™…ã€‚åè€…è¿™é‡Œåªæ˜¯ç®€å•çœ‹ä¸€ä¸‹ï¼Œç”¨åˆ°å¤æ‚çš„æ•°æ®å¯è§†åŒ–å†å»ä»”ç»†çœ‹ç”¨æ³•æŠŠå§ã€‚</p>
<p>ä¸»è¦æ¶‰åŠçš„æ•°æ®æ˜¯è€³ç†Ÿèƒ½è¯¦çš„ Titanicï¼šSurvived å˜é‡æ˜¯äºŒåˆ†ç±»è¡¨ç¤ºæ˜¯å¦å¹¸å­˜ï¼Œç„¶åæ˜¯ Classã€Sex å’Œ Age å‡ ä¸ªäºŒ/å¤šåˆ†ç±»å˜é‡ã€‚ç”±äº <strong>alluvial</strong> ä½œå›¾æ¥å—å®½æ•°æ®å½¢å¼ï¼Œè€Œ Titanic æ•°æ®æœ¬èº«æ˜¯è¡¨æ ¼æ•°æ®ï¼Œ
æ‰€ä»¥è¿˜éœ€è¦é¦–å…ˆ <code>as.data.frame()</code> ä¸€ä¸‹ï¼Œè½¬æˆå®½æ•°æ®å½¢å¼æ•°æ®æ¡†ä¹‹åå°±ä¼šå¤šå‡ºæœ€åä¸€åˆ— <code>Freq</code> äº†è¡¨ç¤ºé¢‘æ•°çš„åˆ—ã€‚æ•°æ®å½¢å¼æ˜¯å¦ç¬¦åˆ <strong>alluvial</strong> ä½œå›¾è¦æ±‚ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ <code>ggalluvial::is_alluvia_form()</code> å‡½æ•°æ¥åˆ¤æ–­ã€‚</p>
<pre class="r"><code>library(&quot;alluvial&quot;)
library(&quot;dplyr&quot;)
library(&quot;magrittr&quot;)
data(&quot;Titanic&quot;)

Titanic
## , , Age = Child, Survived = No
## 
##       Sex
## Class  Male Female
##   1st     0      0
##   2nd     0      0
##   3rd    35     17
##   Crew    0      0
## 
## , , Age = Adult, Survived = No
## 
##       Sex
## Class  Male Female
##   1st   118      4
##   2nd   154     13
##   3rd   387     89
##   Crew  670      3
## 
## , , Age = Child, Survived = Yes
## 
##       Sex
## Class  Male Female
##   1st     5      1
##   2nd    11     13
##   3rd    13     14
##   Crew    0      0
## 
## , , Age = Adult, Survived = Yes
## 
##       Sex
## Class  Male Female
##   1st    57    140
##   2nd    14     80
##   3rd    75     76
##   Crew  192     20
titan &lt;- as.data.frame(Titanic, stringsAsFactors = FALSE)

titan %&gt;% 
  head() %&gt;% 
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Class</th>
<th align="left">Sex</th>
<th align="left">Age</th>
<th align="left">Survived</th>
<th align="right">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1st</td>
<td align="left">Male</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2nd</td>
<td align="left">Male</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">3rd</td>
<td align="left">Male</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">35</td>
</tr>
<tr class="even">
<td align="left">Crew</td>
<td align="left">Male</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">1st</td>
<td align="left">Female</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2nd</td>
<td align="left">Female</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<pre class="r"><code>
ggalluvial::is_alluvia_form(titan)
## [1] TRUE</code></pre>
<div id="quick-start-with-alluvial" class="section level1">
<h1>Quick Start with alluvial</h1>
<p>é¦–å…ˆå¿«é€Ÿçœ‹ <strong>alluvial</strong> å¯è§†åŒ–æ³°å¦å°¼å…‹æ•°æ®çš„ä¾‹å­ï¼š</p>
<pre class="r"><code>alluvial(titan[,1:4], freq = titan$Freq,
         col = ifelse(titan$Survived == &quot;Yes&quot;, &quot;darkgreen&quot;, &quot;darkgrey&quot;),
         border = ifelse(titan$Survived == &quot;Yes&quot;, &quot;darkgreen&quot;, &quot;darkgrey&quot;),
         hide = titan$Freq == 0,
         cex = 0.7)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/alluvial-1.png" width="672" /></p>
<p>å°±è¿™å¼ å›¾æ¥ç®€å•äº†è§£ä¸€ä¸‹ alluvia å›¾çš„ä¸€äº›åŸºæœ¬ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¨ªè½´æ˜¯ä¸åŒçš„åˆ†é‡å˜é‡ï¼Œè‡ªå˜é‡å’Œå› å˜é‡éƒ½å¯ä»¥ç”»è¿›æ¥ï¼›çºµè½´æ˜¯å¯¹åº”åˆ†äº†å˜é‡çš„ä¸åŒç±»åˆ«çš„æ¯”ä¾‹</li>
<li>ä¸€ä¸ªå˜é‡åœ¨çºµè½´ä¸ŠæŸ±å­çš„é«˜åº¦è¡¨ç¤ºåˆ†ç±»çš„æ¯”ä¾‹å¤§å°ï¼›ä»å˜é‡é‡Œç”»å‡ºçš„æ¡å¸¦çš„å®½åº¦ä¹Ÿä»£è¡¨ç›¸åº”éƒ¨åˆ†æ¯”ä¾‹å¤§å°</li>
<li>æ¡å¸¦é¢œè‰²å¯ä»¥å†æ·»åŠ ä¸€ä¸ªç»´åº¦çš„ä¿¡æ¯</li>
</ul>
<p>çŸ¥é“è¿™äº›ä»¥åï¼Œä»…ä»ä¸Šé¢çš„å›¾å°±å¯ä»¥è§£è¯»åˆ°ï¼š</p>
<ul>
<li>èˆ¹ä¸Šæœ€å¤šçš„äººæ˜¯èˆ¹å‘˜ï¼Œç”·æ€§è¿œå¤šäºå¥³æ€§ã€æˆäººè¿œå¤šäºå„¿ç«¥ï¼Œä»¥åŠå¹¸å­˜è€…è¿œå°‘äºé‡éš¾è€…ğŸ•¯ï¸</li>
<li>é‡éš¾è€…å¤§å¤šæ•°æ¥è‡ªä¸‰ç­‰èˆ±å’Œèˆ¹å‘˜ï¼Œè€Œå¥³æ€§é‡éš¾è€…æ¯”ä¾‹æ˜æ˜¾ä½äºç”·æ€§</li>
<li>èˆ¹å‘˜ç»å¤§å¤šæ•°æ˜¯ç”·æ€§ï¼Œå¹¶ä¸”ä»èˆ¹å‘˜åˆ°ä¸€ç­‰èˆ±ï¼Œå¥³æ€§æ¯”ä¾‹è¶Šæ¥è¶Šé«˜ï¼Œæ•´ä½“å¹¸å­˜è€…æ¯”ä¾‹ä¹Ÿè¶Šæ¥è¶Šé«˜</li>
<li>ç»å¤§å¤šæ•°å¥³æ€§é‡éš¾è€…æ¥è‡ªä¸‰ç­‰èˆ±ï¼Œè€Œä¸€ç­‰èˆ±çš„å¥³æ€§å‡ ä¹å…¨éƒ½å¹¸å­˜</li>
</ul>
<p>å†çœ‹ä¸€ä¸ªæ—¶é—´åºåˆ—æ•°æ®çš„ä¾‹å­ï¼š</p>
<pre class="r"><code>Refugees %&gt;% 
  head() %&gt;% 
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="right">year</th>
<th align="right">refugees</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">2003</td>
<td align="right">2136043</td>
</tr>
<tr class="even">
<td align="left">Burundi</td>
<td align="right">2003</td>
<td align="right">531637</td>
</tr>
<tr class="odd">
<td align="left">Congo DRC</td>
<td align="right">2003</td>
<td align="right">453465</td>
</tr>
<tr class="even">
<td align="left">Iraq</td>
<td align="right">2003</td>
<td align="right">368580</td>
</tr>
<tr class="odd">
<td align="left">Myanmar</td>
<td align="right">2003</td>
<td align="right">151384</td>
</tr>
<tr class="even">
<td align="left">Palestine</td>
<td align="right">2003</td>
<td align="right">350568</td>
</tr>
</tbody>
</table>
<pre class="r"><code>
set.seed(39) # for nice colours
cols &lt;- hsv(h = sample(1:10/10), 
            s = sample(3:12)/15,
            v = sample(3:12)/15)

alluvial_ts(Refugees, wave = .3, ygap = 5, 
            col = cols, plotdir = &#39;centred&#39;, alpha=.9,
            grid = TRUE, grid.lwd = 5, xmargin = 0.2, 
            lab.cex = .7,  axis.cex = .8, leg.cex = .7, leg.col = &#39;white&#39;,
            ylab = &#39;&#39;, xlab = &#39;&#39;, border = NA, 
            title = &quot;UNHCR-recognised refugees\nTop 10 countries (2003-13)\n&quot;)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/time-1.png" width="672" /></p>
</div>
<div id="æ›´å¤šç”¨æ³•å’Œè‡ªå®šä¹‰" class="section level1">
<h1>æ›´å¤šç”¨æ³•å’Œè‡ªå®šä¹‰</h1>
<p><strong>alluvial</strong> ç®€å•ä½œå›¾è¦æ±‚æä¾›ä¸€ä¸ªæ•°æ®æ¡†ä½œä¸ºæ•°æ®å‚æ•°ä»¥åŠä¸€ä¸ªå­˜æ”¾å„ä¸ªåˆ†ç±»çš„é¢‘æ•°çš„å‘é‡å‚æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ä¼šä½¿ç”¨å¸¦é€æ˜çš„ç°è‰²æ¡å¸¦ä½œå›¾ã€‚ä¸‹é¢æ˜¯åªç”¨ Titanic æ•°æ®çš„ <code>Class</code> å’Œ <code>Survived</code> ä¸¤ä¸ªå˜é‡ä½œå›¾çš„æƒ…å†µï¼š</p>
<pre class="r"><code># Survival status and Class
titan %&gt;% group_by(Class, Survived) %&gt;%
  summarise(n = sum(Freq)) -&gt; tit2d

alluvial(tit2d[,1:2], freq = tit2d$n, blocks = FALSE)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/twoV-1.png" width="672" /></p>
<p>ä¸‰ä¸ªå˜é‡:</p>
<pre class="r"><code># Survival status, Sex, and Class
titan %&gt;% group_by(Sex, Class, Survived) %&gt;%
  summarise(n = sum(Freq)) -&gt; tit3d

alluvial(tit3d[,1:3], freq = tit3d$n, block = TRUE)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/threeV-1.png" width="672" /></p>
<p>æ³¨æ„ <code>block</code> å‚æ•°çš„ä½œç”¨ã€‚</p>
<div id="éšè—" class="section level2">
<h2>éšè—</h2>
<p><code>hide</code> å‚æ•°å¯ä»¥ç”¨æ¥éšè—ä¸€äº›æ¡å¸¦ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­éšè—äº†æ‰€æœ‰é¢‘æ•°å°äº 100 çš„æ¡å¸¦</p>
<pre class="r"><code>tit3d %&gt;% 
  dplyr::filter(n &lt; 100)
## # A tibble: 9 x 4
## # Groups:   Sex, Class [7]
##   Sex    Class Survived     n
##   &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 Female 1st   No           4
## 2 Female 2nd   No          13
## 3 Female 2nd   Yes         93
## 4 Female 3rd   Yes         90
## 5 Female Crew  No           3
## 6 Female Crew  Yes         20
## 7 Male   1st   Yes         62
## 8 Male   2nd   Yes         25
## 9 Male   3rd   Yes         88

alluvial(tit3d[,1:3], freq=tit3d$n, hide = tit3d$n &lt; 100)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/hide-1.png" width="672" /></p>
<p>å›¾ä¸­å°±èƒ½çœ‹åˆ°è¿™äº›å°‘äº 100 çš„æ¡å¸¦éšè—ä¹‹åå›¾ä¸­æœ‰å¾ˆå¤šç©ºç¼ºï¼ˆgapï¼‰ã€‚è¦å»æ‰è¿™äº› gap é€šè¿‡ <strong>alluvial</strong> åŒ…æœ¬èº«æ— æ³•å®Œæˆï¼Œè€Œéœ€è¦åœ¨ä½œå›¾æ•°æ®ä¸­ç­›é€‰æ•°æ®å†ä½œå›¾ã€‚</p>
</div>
<div id="æ”¹å˜å±‚æ¬¡" class="section level2">
<h2>æ”¹å˜å±‚æ¬¡</h2>
<p>é»˜è®¤æƒ…å†µä¸‹ <strong>alluvial</strong> ä½œå›¾æ—¶æ¡å¸¦çš„é¡ºåºå°±æ˜¯æä¾›æ•°æ®çš„è¡Œçš„é¡ºåºï¼Œè¡Œåœ¨å‰çš„åœ¨ä¸Šå±‚ï¼ˆæ³¨æ„ç”»å›¾ç›¸å½“äºä»ä¸‹å¾€ä¸Šç”»æ¡å¸¦ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªæ¡å¸¦åœ¨å›¾çš„æœ€å‰å›¾å±‚ï¼Œä½†æ˜¯ä½ç½®å´åœ¨ä¸‹æ–¹ï¼‰ã€‚æ”¹å˜æ•°æ®é‡Œè¡Œçš„é¡ºåºå°±èƒ½æ”¹å˜æ¡å¸¦çš„é¡ºåºï¼š</p>
<pre class="r"><code>d &lt;- data.frame(
  x = c(1, 2, 3),
  y = c(3 ,2, 1),
  freq = c(1, 1, 1)
)
d
##   x y freq
## 1 1 3    1
## 2 2 2    1
## 3 3 1    1

alluvial(d[, 1:2],
         freq = d$freq,
         col = 1:3,
         alpha = 1)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/layers-1.png" width="672" /></p>
<pre class="r"><code># Reversing the order
alluvial(d[3:1, 1:2],
         freq = d$freq,
         col = 3:1,
         alpha = 1)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/layers-2.png" width="672" /></p>
<p>æ³¨æ„åé¢çš„ä»£ç é‡ŒæŒ‡å®šäº†é¢œè‰²å¹¶ä¸”ä¹Ÿæ˜¯ <code>3:1</code> åè¿‡æ¥çš„ï¼Œè¿™æ˜¯ä¸ºäº†å¯¹åº”åè¿‡æ¥çš„è¡Œï¼Œä¸ä¹‹å‰çš„å›¾é¢œè‰²å¯ä»¥ä¿æŒä¸€è‡´ã€‚</p>
<p>é€šè¿‡ <code>layer</code> å‚æ•°æŒ‡å®šå›¾å±‚é¡ºåºå¯ä»¥ç®€å•çš„è¾¾åˆ°ä¸€æ ·çš„ç›®çš„ï¼š</p>
<pre class="r"><code>alluvial(
  d[, 1:2],
  freq = d$freq,
  col = 1:3,
  alpha = 1,
  layer = 3:1
)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/layer_para-1.png" width="672" /></p>
<p>ä½†æ˜¯é€šè¿‡å‚æ•°æ”¹å›¾å±‚é¡ºåºå°±ä¸éœ€è¦å†æ‰‹åŠ¨å»è°ƒæ•´é¢œè‰²é¡ºåºäº†ã€‚</p>
<p><code>layer</code> å‚æ•°å¯ä»¥æ¥å—ä¸€ä¸ªé€»è¾‘å€¼ï¼Œæ¯”å¦‚æœ‰æ—¶å€™åªæƒ³æŒ‡å®šæ¯ä¸ªç‰¹å®šæ¡å¸¦å¤„äºæœ€ä¸Šæ–¹ã€‚ä¸‹é¢çš„ä¾‹å­é‡ŒæŠŠä»£è¡¨æ‰€æœ‰å¹¸å­˜è€…çš„æ¡å¸¦æ”¾åœ¨æœ€ä¸Šé¢ï¼š</p>
<pre class="r"><code>alluvial(tit3d[,1:3], freq = tit3d$n, 
         col = ifelse( tit3d$Survived == &quot;Yes&quot;, &quot;orange&quot;, &quot;grey&quot; ),
         alpha = 0.8,
         layer = tit3d$Survived == &quot;No&quot;
)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/layer_logic-1.png" width="672" /></p>
<p>å¤„ç†é€»è¾‘å€¼çš„æ—¶å€™ç”± <code>order()</code> å®Œæˆï¼Œæ‰€ä»¥äº‹å®ä¸Šæ˜¯å¯¹ <code>TRUE</code>/<code>FALSE</code> æ’åºï¼Œè€Œ <code>TRUE</code>/<code>FALSE</code> åˆ†åˆ«æ˜¯ 1/0ï¼Œæ‰€ä»¥ç»“æœæ˜¯ <code>FALSE</code> åœ¨å‰è€Œ <code>TRUE</code> åœ¨åã€‚æ‰€ä»¥ä¸Šé¢ç”»å›¾çš„ç»“æœå°±æ˜¯åè€Œ <code>tit3d$Survived == "No"</code> æ˜¯åœ¨ä¸‹é¢ã€‚</p>
</div>
</div>
<div id="ggplot2-ggalluvial" class="section level1">
<h1>ggplot2: ggalluvial</h1>
<p>é¦–å…ˆç®€å•ç²—æš´çš„çœ‹ä¸€ä¸ªä¾‹å­å§ï¼š</p>
<pre class="r"><code>library(&quot;ggalluvial&quot;)

Titanic %&gt;% 
  as.data.frame() %&gt;%
  head() %&gt;% 
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Class</th>
<th align="left">Sex</th>
<th align="left">Age</th>
<th align="left">Survived</th>
<th align="right">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1st</td>
<td align="left">Male</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2nd</td>
<td align="left">Male</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">3rd</td>
<td align="left">Male</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">35</td>
</tr>
<tr class="even">
<td align="left">Crew</td>
<td align="left">Male</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">1st</td>
<td align="left">Female</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">2nd</td>
<td align="left">Female</td>
<td align="left">Child</td>
<td align="left">No</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<pre class="r"><code>
ggplot(as.data.frame(Titanic),
       aes(y = Freq, 
           axis1 = Survived, axis2 = Sex, axis3 = Class)) +
  geom_alluvium(aes(fill = Class), 
                width = 0, knot.pos = 0, reverse = FALSE) +
  guides(fill = FALSE) +
  geom_stratum(width = 1/8, reverse = FALSE) +
  geom_text(stat = &quot;stratum&quot;, label.strata = TRUE, reverse = FALSE) +
  scale_x_continuous(breaks = 1:3, labels = c(&quot;Survived&quot;, &quot;Sex&quot;, &quot;Class&quot;))</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/gg-1.png" width="672" /></p>
<p><strong>ggalluvial</strong> æ”¯æŒé•¿æ•°æ®å’Œå®½æ•°æ®æ ¼å¼ï¼Œä½†ä¸ºäº†ä¿æŒä¸ <em>tidyverse</em> è¯­æ³•çš„ä¸€è‡´æ€§è€Œä¸æ”¯æŒè¡¨æ ¼æ•°æ®æ ¼å¼ï¼ˆè€Œä¸Šé¢ç”¨åˆ°çš„ Titanic å’Œä¸‹é¢ä¼šç”¨åˆ°çš„ UCBAdmissions éƒ½æ˜¯ çš„åŸå§‹æ•°æ®è¡¨æ ¼æ•°æ®çš„ï¼‰ã€‚</p>
<div id="å®½æ•°æ®æ ¼å¼" class="section level2">
<h2>å®½æ•°æ®æ ¼å¼</h2>
<p>å®½æ•°æ®æ ¼å¼æ¯ä¸€è¡Œä»£è¡¨ç”±åˆ—å–å€¼ä¸åŒçš„ç»„åˆæ‰€å½¢æˆçš„ä¸€ç§äººç¾¤ï¼Œç„¶åä¼šæœ‰ä¸€åˆ—å•ç‹¬è¡¨ç¤ºæƒé‡ï¼ˆå³è¯¥äººç¾¤çš„é¢‘æ•°ï¼‰ã€‚å®½æ•°æ®çš„æ¯ä¸€è¡Œå¯¹åº”åˆ°å†²ç§¯å›¾ä¸­ç›¸å½“äºä¸€ä¸ªæ¡å¸¦ã€‚<code>as.data.frame()</code> é»˜è®¤æƒ…å†µä¸‹å°±ä¼šæŠŠé¢‘æ•°è¡¨è½¬æ¢æˆå®½æ•°æ®å½¢å¼ã€‚
UCBAdmissions æ˜¯ä¸€ä¸ª Berkeley ç ”ç©¶ç”Ÿç”³è¯·æƒ…å†µçš„ç®€å•æ•°æ®ã€‚Admit æ˜¯ç”³è¯·æˆåŠŸè¿˜æ˜¯è¢«æ‹’ï¼ŒGender æ˜¯æ€§åˆ«è€Œ Dept è¡¨ç¤ºéƒ¨é—¨ã€‚æ¥ <code>as.data.frame()</code> çœ‹ä¸€ä¸‹ï¼š</p>
<pre class="r"><code>is_alluvia_form(as.data.frame(UCBAdmissions), axes = 1:3, silent = TRUE)
## [1] TRUE

UCBAdmissions %&gt;% 
  as.data.frame() %&gt;% 
  head() %&gt;% 
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">Admit</th>
<th align="left">Gender</th>
<th align="left">Dept</th>
<th align="right">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Admitted</td>
<td align="left">Male</td>
<td align="left">A</td>
<td align="right">512</td>
</tr>
<tr class="even">
<td align="left">Rejected</td>
<td align="left">Male</td>
<td align="left">A</td>
<td align="right">313</td>
</tr>
<tr class="odd">
<td align="left">Admitted</td>
<td align="left">Female</td>
<td align="left">A</td>
<td align="right">89</td>
</tr>
<tr class="even">
<td align="left">Rejected</td>
<td align="left">Female</td>
<td align="left">A</td>
<td align="right">19</td>
</tr>
<tr class="odd">
<td align="left">Admitted</td>
<td align="left">Male</td>
<td align="left">B</td>
<td align="right">353</td>
</tr>
<tr class="even">
<td align="left">Rejected</td>
<td align="left">Male</td>
<td align="left">B</td>
<td align="right">207</td>
</tr>
</tbody>
</table>
<p>æœç„¶ï¼Œ<code>as.data.frame()</code> ä¼šæŠŠæ•°æ®è½¬æ¢æˆåˆšåˆšä¸Šé¢æè¿°çš„å®½æ•°æ®å½¢å¼ã€‚ç„¶åè¿™ä¸ªæ•°æ®å°±å¯ä»¥ç›´æ¥æ‹¿æ¥åšå†²ç§¯å›¾äº†ã€‚</p>
<p><strong>ggalluvial</strong> ä½œå›¾è¯­æ³•ä¹Ÿæ˜¯ä¸ <strong>alluvial</strong> ç›¸ä¸€è‡´çš„ï¼šç”¨æˆ·éœ€è¦æŒ‡å®š <code>axis</code> å‚æ•°ï¼Œè¿™ä¸€å‚æ•°ä¼šè¢« <code>stat_alluvium()</code> å’Œ <code>stat_stratum()</code> è¯†åˆ«å¤„ç†ï¼š</p>
<pre class="r"><code>ggplot(as.data.frame(UCBAdmissions),
       aes(y = Freq, axis1 = Gender, axis2 = Dept)) +
  geom_alluvium(aes(fill = Admit), width = 1/12) +
  geom_stratum(width = 1/12, fill = &quot;black&quot;, color = &quot;grey&quot;) +
  geom_label(stat = &quot;stratum&quot;, label.strata = TRUE) +
  scale_x_discrete(limits = c(&quot;Gender&quot;, &quot;Dept&quot;), expand = c(.05, .05)) +
  scale_fill_brewer(type = &quot;qual&quot;, palette = &quot;Set1&quot;) +
  ggtitle(&quot;UC Berkeley admissions and rejections, by sex and department&quot;) +
  theme_bw()</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/geom_alluvial-1.png" width="672" /></p>
<p>è¿™ä¸ªä½œå›¾ç”¨åˆ°äº†å¸¸ç”¨çš„å¾ˆå¤šè¯­å¥ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯ <code>geom_alluvium()</code> å’Œ <code>geom_stratum()</code>ï¼Œå‰è€…ç”»æ¡å¸¦ï¼Œåè€…ç”»æŸ±å­ã€‚å…¶ä»–å¯ä»¥ä¸€ä¸ªä¸€ä¸ªå»æ‰çœ‹çœ‹å›¾å½¢å‘ç”Ÿå˜åŒ–æ¥äº†è§£æ¯ä¸€ä¸ªå‚æ•°çš„ä½œç”¨ã€‚</p>
<p><strong>ggalluvial</strong> ä½œå‡ºæ¥çš„å›¾æœ‰ä¸€ä¸ªæœ‰ç‚¹å°±æ˜¯ Y è½´æ˜¯æœ‰æ„ä¹‰çš„ã€‚Y è½´æ˜¯ä¾æ®åŸæœ¬æ•°æ®çš„å°ºåº¦è€Œæ²¡æœ‰åšä»»ä½•è½¬æ¢ç›´æ¥ç”Ÿæˆçš„ï¼Œæ•°æ®ä¸­ä¹Ÿæ²¡æœ‰é—´éš”ï¼Œæ‰€ä»¥ Y è½´ä¸Šç”»çš„æŸ±å­å®é™…ä¸Šç›¸å½“äºå †å èµ·æ¥çš„æŸ±çŠ¶å›¾ã€‚</p>
</div>
<div id="é•¿æ•°æ®æ ¼å¼" class="section level2">
<h2>é•¿æ•°æ®æ ¼å¼</h2>
<p><strong>ggalluvial</strong> è¯†åˆ«çš„é•¿æ•°æ®æ ¼å¼æ˜¯ç±»ä¼¼äº <strong>dyplr</strong> çš„ <code>gather()</code> å¾—åˆ°çš„æ•°æ®é‚£ç§å½¢å¼ï¼Œæ¯ä¸€è¡Œéƒ½ä»£è¡¨å†²ç§¯å›¾ä¸­çš„ä¸€ä¸ªæ¡å¸¦ã€‚</p>
<pre class="r"><code>UCB_lodes &lt;-  to_lodes_form(as.data.frame(UCBAdmissions),
                           axes = 1:3,
                           id = &quot;Cohort&quot;)
head(UCB_lodes, n = 12)
##    Freq Cohort     x  stratum
## 1   512      1 Admit Admitted
## 2   313      2 Admit Rejected
## 3    89      3 Admit Admitted
## 4    19      4 Admit Rejected
## 5   353      5 Admit Admitted
## 6   207      6 Admit Rejected
## 7    17      7 Admit Admitted
## 8     8      8 Admit Rejected
## 9   120      9 Admit Admitted
## 10  205     10 Admit Rejected
## 11  202     11 Admit Admitted
## 12  391     12 Admit Rejected

is_lodes_form(
  UCB_lodes,
  key = x,
  value = stratum,
  id = Cohort,
  silent = TRUE)
## [1] TRUE</code></pre>
<p>è¿˜æœ‰ä¸€ä¸ª <strong>ggalluvial</strong> èƒ½åšçš„æ˜¯æ ¹æ®æ•°æ®ç”» <code>geom_flow()</code> å›¾ã€‚ <code>geom_flow()</code> å›¾åœ¨æ¯ä¸€ä¸ªè½´ä¸Šå¯ä»¥é‡æ–°è®¾ç½®æ•°æ®æ˜ å°„å…³ç³»ï¼Œç”¨æ¥å±•ç¤ºåŒä¸€æ•°æ®çš„å˜åŒ–ã€é‡å¤æµ‹é‡æ•°æ®ä¼šå¾ˆåˆé€‚ï¼š</p>
<pre class="r"><code>data(majors)
majors$curriculum &lt;- as.factor(majors$curriculum)
head(majors)
##   student semester curriculum
## 1       1    CURR1   Painting
## 2       2    CURR1   Painting
## 3       6    CURR1   Sculpure
## 4       8    CURR1   Painting
## 5       9    CURR1   Sculpure
## 6      10    CURR1   Painting

ggplot(majors,
       aes(x = semester,
           stratum = curriculum,
           alluvium = student,
           fill = curriculum, 
           label = curriculum)) +
  scale_fill_brewer(type = &quot;qual&quot;, 
                    palette = &quot;Set2&quot;) +
  geom_flow(stat = &quot;alluvium&quot;, 
            lode.guidance = &quot;frontback&quot;,
            color = &quot;darkgray&quot;) +
  geom_stratum() +
  theme(legend.position = &quot;bottom&quot;) +
  theme_minimal() +
  # title(&quot;student curricula across several semesters&quot;) +
  NULL</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/geom_flow-1.png" width="672" /></p>
<p>è¿™å¼ å›¾åŒæ—¶è¿˜å±•ç¤ºäº† <code>NA</code> çš„ä¸€ç§å¤„ç†åŠæ³•ï¼Œè¿˜å¯ä»¥è®¾ç½®å‚æ•° <code>na.rm = TRUE</code>ã€‚ç¼ºå¤±å€¼çš„å¤„ç†å’Œ <code>strata</code> å˜é‡æ˜¯å­—ç¬¦å‹è¿˜æ˜¯å› å­æˆ–æ•°å€¼å‹çš„æ•°æ®ç±»å‹æœ‰å…³ã€‚</p>
<p>é•¿æ•°æ®å½¢å¼è¿˜å…è®¸åœ¨ç›¸é‚»è½´ä¹‹é—´è¿›è¡Œåˆå¹¶ï¼Œè¿™å¯¹äºæŸ¥çœ‹æ•°æ®åœ¨ç›¸é‚»çš„ä¸¤ä¸ªè½´ä¹‹é—´çš„å˜åŒ–å¾ˆä¾¿åˆ©ï¼š</p>
<pre class="r"><code>data(vaccinations)
head(vaccinations)
##   freq           a subject    survey response
## 1   48 0.050367261       1 ms153_NSA   Always
## 2    9 0.009443861       2 ms153_NSA   Always
## 3   66 0.069254984       3 ms153_NSA   Always
## 4    1 0.001049318       4 ms153_NSA   Always
## 5   11 0.011542497       5 ms153_NSA   Always
## 6    1 0.001049318       6 ms153_NSA   Always
levels(vaccinations$response) &lt;- rev(levels(vaccinations$response))

ggplot(vaccinations,
       aes(x = survey, stratum = response, alluvium = subject,
           y = freq,
           fill = response, label = response)) +
  scale_x_discrete(expand = c(.1, .1)) +
  geom_flow() +
  geom_stratum(alpha = .5) +
  geom_text(stat = &quot;stratum&quot;, size = 3) +
  theme(legend.position = &quot;none&quot;) +
  ggtitle(&quot;vaccination survey responses at three points in time&quot;)</code></pre>
<p><img src="/post/2019-06-10-alluvium-diagram_files/figure-html/vaccinations-1.png" width="672" /></p>
<p>å—¯ï¼Œå°±è¿™äº›ã€‚<strong>ggalluvial</strong> èƒ½åš flow å›¾æ˜¯ä¸€ä¸ªä¼˜åŠ¿ã€‚</p>
</div>
</div>

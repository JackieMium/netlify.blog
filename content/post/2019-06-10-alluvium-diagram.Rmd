---
title: alluvial diagram å†²ç§¯å›¾
author: Jackie
date: '2019-06-10'
slug: alluvial-diagram
categories:
  - R
tags:
  - ggplot2
  - R
  - Viz
disable_comments: no
show_toc: yes
output:
  blogdown::html_page:
    toc: yes
---

```{r setup, echo=FALSE, message = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE,collapse = TRUE)
library("alluvial")
library("ggalluvial")
library("ggplot2")
```

![geom_alluvium](/post/2019-06-10-ggplot-geom-alluvium_files/0.geom_alluvium.png)

æœ€è¿‘çœ‹æ–‡çŒ®çœ‹åˆ°ä¸€ç§æ–°çš„æ•°æ®å¯è§†åŒ–å›¾ï¼ŒAlluvia å›¾ï¼Œä¸­æ–‡åº”è¯¥æ˜¯å†²ç§¯å›¾ï¼Ÿä¸çŸ¥é“ã€‚è¿™ç§å›¾å½¢ç”¨æ¥å±•ç¤ºåˆ†ç±»æ•°æ®ï¼Œå°¤å…¶æ˜¯å¤šä¸ªåˆ†ç±»æ•°æ®ä»¥åŠ Logistic å›å½’é‡Œï¼Œç¾è§‚è€Œä¸”ç›´è§‚ï¼Œæ‰€ä»¥å†³å®šçœ‹ä¸€ä¸‹ã€‚

å‚è€ƒä¸»è¦æ˜¯ [**alluvial**](https://cran.r-project.org/web/packages/alluvial/vignettes/alluvial.html) å’Œ [**ggalluvial**](https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html) çš„æ–‡æ¡£ ï¼Œæœ‰åˆ æ”¹ã€‚

**alluvial** æ˜¯ä¼ ç»Ÿçš„ Alluvia å›¾ä½œå›¾åŒ…ï¼Œè€Œ **ggalluvial** ä»åå­—å°±èƒ½çœ‹å‡ºæ¥æ˜¯ **ggplot2** åŒ…ã€‚

ä¸»è¦çœ‹ alluvial çš„ç”¨æ³•ï¼Œå› ä¸ºå®ƒå¯¹åº” base ä½œå›¾ç³»ç»Ÿï¼Œæ‰€ä»¥è¯­æ³•ç®€å•ç›´æ¥ã€‚**alluvial** æ¥å—çš„æ•°æ®å½¢å¼æ˜¯å®½æ•°æ®ï¼Œå³æ•´ç†å¥½çš„é¢‘æ•°è¡¨å½¢å¼ã€‚**ggalluvial** æ˜¯ **ggplot2** è¯­æ³•ç³»ç»Ÿï¼Œè‡ªå®šä¹‰ç¨‹åº¦é«˜ï¼Œç”¨æ³•ä¸°å¯Œã€‚**ggalluvial** æ¥å—é•¿æ•°æ®å’Œå®½æ•°æ®ä¸¤ç§å½¢å¼ï¼ŒåŒæ—¶ä¸ºäº†ä¿æŒ _tidyverse_ è¯­æ³•ä¸€è‡´ï¼Œä¸æ”¯æŒé¢‘æ•°è¡¨ğŸ™…ã€‚åè€…è¿™é‡Œåªæ˜¯ç®€å•çœ‹ä¸€ä¸‹ï¼Œç”¨åˆ°å¤æ‚çš„æ•°æ®å¯è§†åŒ–å†å»ä»”ç»†çœ‹ç”¨æ³•æŠŠå§ã€‚

ä¸»è¦æ¶‰åŠçš„æ•°æ®æ˜¯è€³ç†Ÿèƒ½è¯¦çš„ Titanicï¼šSurvived å˜é‡æ˜¯äºŒåˆ†ç±»è¡¨ç¤ºæ˜¯å¦å¹¸å­˜ï¼Œç„¶åæ˜¯ Classã€Sex å’Œ Age å‡ ä¸ªäºŒ/å¤šåˆ†ç±»å˜é‡ã€‚ç”±äº **alluvial** ä½œå›¾æ¥å—å®½æ•°æ®å½¢å¼ï¼Œè€Œ Titanic æ•°æ®æœ¬èº«æ˜¯è¡¨æ ¼æ•°æ®ï¼Œ
æ‰€ä»¥è¿˜éœ€è¦é¦–å…ˆ `as.data.frame()` ä¸€ä¸‹ï¼Œè½¬æˆå®½æ•°æ®å½¢å¼æ•°æ®æ¡†ä¹‹åå°±ä¼šå¤šå‡ºæœ€åä¸€åˆ— `Freq` äº†è¡¨ç¤ºé¢‘æ•°çš„åˆ—ã€‚æ•°æ®å½¢å¼æ˜¯å¦ç¬¦åˆ **alluvial** ä½œå›¾è¦æ±‚ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ `ggalluvial::is_alluvia_form()` å‡½æ•°æ¥åˆ¤æ–­ã€‚

```{r data, collapse=TRUE, message=FALSE}
library("alluvial")
library("dplyr")
library("magrittr")
data("Titanic")

Titanic
titan <- as.data.frame(Titanic, stringsAsFactors = FALSE)

titan %>% 
  head() %>% 
  knitr::kable()

ggalluvial::is_alluvia_form(titan)
```

# Quick Start with alluvial

é¦–å…ˆå¿«é€Ÿçœ‹ **alluvial** å¯è§†åŒ–æ³°å¦å°¼å…‹æ•°æ®çš„ä¾‹å­ï¼š

```{r alluvial}
alluvial(titan[,1:4], freq = titan$Freq,
         col = ifelse(titan$Survived == "Yes", "darkgreen", "darkgrey"),
         border = ifelse(titan$Survived == "Yes", "darkgreen", "darkgrey"),
         hide = titan$Freq == 0,
         cex = 0.7)
```

å°±è¿™å¼ å›¾æ¥ç®€å•äº†è§£ä¸€ä¸‹ alluvia å›¾çš„ä¸€äº›åŸºæœ¬ç‰¹ç‚¹ï¼š

- æ¨ªè½´æ˜¯ä¸åŒçš„åˆ†é‡å˜é‡ï¼Œè‡ªå˜é‡å’Œå› å˜é‡éƒ½å¯ä»¥ç”»è¿›æ¥ï¼›çºµè½´æ˜¯å¯¹åº”åˆ†äº†å˜é‡çš„ä¸åŒç±»åˆ«çš„æ¯”ä¾‹
- ä¸€ä¸ªå˜é‡åœ¨çºµè½´ä¸ŠæŸ±å­çš„é«˜åº¦è¡¨ç¤ºåˆ†ç±»çš„æ¯”ä¾‹å¤§å°ï¼›ä»å˜é‡é‡Œç”»å‡ºçš„æ¡å¸¦çš„å®½åº¦ä¹Ÿä»£è¡¨ç›¸åº”éƒ¨åˆ†æ¯”ä¾‹å¤§å°
- æ¡å¸¦é¢œè‰²å¯ä»¥å†æ·»åŠ ä¸€ä¸ªç»´åº¦çš„ä¿¡æ¯

çŸ¥é“è¿™äº›ä»¥åï¼Œä»…ä»ä¸Šé¢çš„å›¾å°±å¯ä»¥è§£è¯»åˆ°ï¼š

- èˆ¹ä¸Šæœ€å¤šçš„äººæ˜¯èˆ¹å‘˜ï¼Œç”·æ€§è¿œå¤šäºå¥³æ€§ã€æˆäººè¿œå¤šäºå„¿ç«¥ï¼Œä»¥åŠå¹¸å­˜è€…è¿œå°‘äºé‡éš¾è€…ğŸ•¯ï¸
- é‡éš¾è€…å¤§å¤šæ•°æ¥è‡ªä¸‰ç­‰èˆ±å’Œèˆ¹å‘˜ï¼Œè€Œå¥³æ€§é‡éš¾è€…æ¯”ä¾‹æ˜æ˜¾ä½äºç”·æ€§
- èˆ¹å‘˜ç»å¤§å¤šæ•°æ˜¯ç”·æ€§ï¼Œå¹¶ä¸”ä»èˆ¹å‘˜åˆ°ä¸€ç­‰èˆ±ï¼Œå¥³æ€§æ¯”ä¾‹è¶Šæ¥è¶Šé«˜ï¼Œæ•´ä½“å¹¸å­˜è€…æ¯”ä¾‹ä¹Ÿè¶Šæ¥è¶Šé«˜
- ç»å¤§å¤šæ•°å¥³æ€§é‡éš¾è€…æ¥è‡ªä¸‰ç­‰èˆ±ï¼Œè€Œä¸€ç­‰èˆ±çš„å¥³æ€§å‡ ä¹å…¨éƒ½å¹¸å­˜

å†çœ‹ä¸€ä¸ªæ—¶é—´åºåˆ—æ•°æ®çš„ä¾‹å­ï¼š

```{r time}
Refugees %>% 
  head() %>% 
  knitr::kable()

set.seed(39) # for nice colours
cols <- hsv(h = sample(1:10/10), 
            s = sample(3:12)/15,
            v = sample(3:12)/15)

alluvial_ts(Refugees, wave = .3, ygap = 5, 
            col = cols, plotdir = 'centred', alpha=.9,
            grid = TRUE, grid.lwd = 5, xmargin = 0.2, 
            lab.cex = .7,  axis.cex = .8, leg.cex = .7, leg.col = 'white',
            ylab = '', xlab = '', border = NA, 
            title = "UNHCR-recognised refugees\nTop 10 countries (2003-13)\n")
```

# æ›´å¤šç”¨æ³•å’Œè‡ªå®šä¹‰

**alluvial** ç®€å•ä½œå›¾è¦æ±‚æä¾›ä¸€ä¸ªæ•°æ®æ¡†ä½œä¸ºæ•°æ®å‚æ•°ä»¥åŠä¸€ä¸ªå­˜æ”¾å„ä¸ªåˆ†ç±»çš„é¢‘æ•°çš„å‘é‡å‚æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ä¼šä½¿ç”¨å¸¦é€æ˜çš„ç°è‰²æ¡å¸¦ä½œå›¾ã€‚ä¸‹é¢æ˜¯åªç”¨ Titanic æ•°æ®çš„ `Class` å’Œ `Survived` ä¸¤ä¸ªå˜é‡ä½œå›¾çš„æƒ…å†µï¼š

```{r twoV}
# Survival status and Class
titan %>% group_by(Class, Survived) %>%
  summarise(n = sum(Freq)) -> tit2d

alluvial(tit2d[,1:2], freq = tit2d$n, blocks = FALSE)
```

ä¸‰ä¸ªå˜é‡:

```{r threeV}
# Survival status, Sex, and Class
titan %>% group_by(Sex, Class, Survived) %>%
  summarise(n = sum(Freq)) -> tit3d

alluvial(tit3d[,1:3], freq = tit3d$n, block = TRUE)
```

æ³¨æ„ `block` å‚æ•°çš„ä½œç”¨ã€‚

## éšè—

`hide` å‚æ•°å¯ä»¥ç”¨æ¥éšè—ä¸€äº›æ¡å¸¦ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­éšè—äº†æ‰€æœ‰é¢‘æ•°å°äº 100 çš„æ¡å¸¦

```{r hide}
tit3d %>% 
  dplyr::filter(n < 100)

alluvial(tit3d[,1:3], freq=tit3d$n, hide = tit3d$n < 100)
```

å›¾ä¸­å°±èƒ½çœ‹åˆ°è¿™äº›å°‘äº 100 çš„æ¡å¸¦éšè—ä¹‹åå›¾ä¸­æœ‰å¾ˆå¤šç©ºç¼ºï¼ˆgapï¼‰ã€‚è¦å»æ‰è¿™äº› gap é€šè¿‡ **alluvial** åŒ…æœ¬èº«æ— æ³•å®Œæˆï¼Œè€Œéœ€è¦åœ¨ä½œå›¾æ•°æ®ä¸­ç­›é€‰æ•°æ®å†ä½œå›¾ã€‚

## æ”¹å˜å±‚æ¬¡

é»˜è®¤æƒ…å†µä¸‹ **alluvial** ä½œå›¾æ—¶æ¡å¸¦çš„é¡ºåºå°±æ˜¯æä¾›æ•°æ®çš„è¡Œçš„é¡ºåºï¼Œè¡Œåœ¨å‰çš„åœ¨ä¸Šå±‚ï¼ˆæ³¨æ„ç”»å›¾ç›¸å½“äºä»ä¸‹å¾€ä¸Šç”»æ¡å¸¦ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªæ¡å¸¦åœ¨å›¾çš„æœ€å‰å›¾å±‚ï¼Œä½†æ˜¯ä½ç½®å´åœ¨ä¸‹æ–¹ï¼‰ã€‚æ”¹å˜æ•°æ®é‡Œè¡Œçš„é¡ºåºå°±èƒ½æ”¹å˜æ¡å¸¦çš„é¡ºåºï¼š

```{r layers, collapse = TRUE}
d <- data.frame(
  x = c(1, 2, 3),
  y = c(3 ,2, 1),
  freq = c(1, 1, 1)
)
d

alluvial(d[, 1:2],
         freq = d$freq,
         col = 1:3,
         alpha = 1)
# Reversing the order
alluvial(d[3:1, 1:2],
         freq = d$freq,
         col = 3:1,
         alpha = 1)
```

æ³¨æ„åé¢çš„ä»£ç é‡ŒæŒ‡å®šäº†é¢œè‰²å¹¶ä¸”ä¹Ÿæ˜¯ `3:1` åè¿‡æ¥çš„ï¼Œè¿™æ˜¯ä¸ºäº†å¯¹åº”åè¿‡æ¥çš„è¡Œï¼Œä¸ä¹‹å‰çš„å›¾é¢œè‰²å¯ä»¥ä¿æŒä¸€è‡´ã€‚

é€šè¿‡ `layer` å‚æ•°æŒ‡å®šå›¾å±‚é¡ºåºå¯ä»¥ç®€å•çš„è¾¾åˆ°ä¸€æ ·çš„ç›®çš„ï¼š

```{r layer_para}
alluvial(
  d[, 1:2],
  freq = d$freq,
  col = 1:3,
  alpha = 1,
  layer = 3:1
)
```

ä½†æ˜¯é€šè¿‡å‚æ•°æ”¹å›¾å±‚é¡ºåºå°±ä¸éœ€è¦å†æ‰‹åŠ¨å»è°ƒæ•´é¢œè‰²é¡ºåºäº†ã€‚

`layer` å‚æ•°å¯ä»¥æ¥å—ä¸€ä¸ªé€»è¾‘å€¼ï¼Œæ¯”å¦‚æœ‰æ—¶å€™åªæƒ³æŒ‡å®šæ¯ä¸ªç‰¹å®šæ¡å¸¦å¤„äºæœ€ä¸Šæ–¹ã€‚ä¸‹é¢çš„ä¾‹å­é‡ŒæŠŠä»£è¡¨æ‰€æœ‰å¹¸å­˜è€…çš„æ¡å¸¦æ”¾åœ¨æœ€ä¸Šé¢ï¼š

```{r layer_logic}
alluvial(tit3d[,1:3], freq = tit3d$n, 
         col = ifelse( tit3d$Survived == "Yes", "orange", "grey" ),
         alpha = 0.8,
         layer = tit3d$Survived == "No"
)
```

å¤„ç†é€»è¾‘å€¼çš„æ—¶å€™ç”± `order()` å®Œæˆï¼Œæ‰€ä»¥äº‹å®ä¸Šæ˜¯å¯¹ `TRUE`/`FALSE` æ’åºï¼Œè€Œ `TRUE`/`FALSE` åˆ†åˆ«æ˜¯ 1/0ï¼Œæ‰€ä»¥ç»“æœæ˜¯ `FALSE` åœ¨å‰è€Œ `TRUE` åœ¨åã€‚æ‰€ä»¥ä¸Šé¢ç”»å›¾çš„ç»“æœå°±æ˜¯åè€Œ `tit3d$Survived == "No"` æ˜¯åœ¨ä¸‹é¢ã€‚

# ggplot2: ggalluvial

é¦–å…ˆç®€å•ç²—æš´çš„çœ‹ä¸€ä¸ªä¾‹å­å§ï¼š

```{r gg}
library("ggalluvial")

Titanic %>% 
  as.data.frame() %>%
  head() %>% 
  knitr::kable()

ggplot(as.data.frame(Titanic),
       aes(y = Freq, 
           axis1 = Survived, axis2 = Sex, axis3 = Class)) +
  geom_alluvium(aes(fill = Class), 
                width = 0, knot.pos = 0, reverse = FALSE) +
  guides(fill = FALSE) +
  geom_stratum(width = 1/8, reverse = FALSE) +
  geom_text(stat = "stratum", label.strata = TRUE, reverse = FALSE) +
  scale_x_continuous(breaks = 1:3, labels = c("Survived", "Sex", "Class"))
```

**ggalluvial** æ”¯æŒé•¿æ•°æ®å’Œå®½æ•°æ®æ ¼å¼ï¼Œä½†ä¸ºäº†ä¿æŒä¸ _tidyverse_ è¯­æ³•çš„ä¸€è‡´æ€§è€Œä¸æ”¯æŒè¡¨æ ¼æ•°æ®æ ¼å¼ï¼ˆè€Œä¸Šé¢ç”¨åˆ°çš„ Titanic å’Œä¸‹é¢ä¼šç”¨åˆ°çš„ UCBAdmissions éƒ½æ˜¯ çš„åŸå§‹æ•°æ®è¡¨æ ¼æ•°æ®çš„ï¼‰ã€‚

## å®½æ•°æ®æ ¼å¼

å®½æ•°æ®æ ¼å¼æ¯ä¸€è¡Œä»£è¡¨ç”±åˆ—å–å€¼ä¸åŒçš„ç»„åˆæ‰€å½¢æˆçš„ä¸€ç§äººç¾¤ï¼Œç„¶åä¼šæœ‰ä¸€åˆ—å•ç‹¬è¡¨ç¤ºæƒé‡ï¼ˆå³è¯¥äººç¾¤çš„é¢‘æ•°ï¼‰ã€‚å®½æ•°æ®çš„æ¯ä¸€è¡Œå¯¹åº”åˆ°å†²ç§¯å›¾ä¸­ç›¸å½“äºä¸€ä¸ªæ¡å¸¦ã€‚`as.data.frame()` é»˜è®¤æƒ…å†µä¸‹å°±ä¼šæŠŠé¢‘æ•°è¡¨è½¬æ¢æˆå®½æ•°æ®å½¢å¼ã€‚
UCBAdmissions æ˜¯ä¸€ä¸ª Berkeley ç ”ç©¶ç”Ÿç”³è¯·æƒ…å†µçš„ç®€å•æ•°æ®ã€‚Admit æ˜¯ç”³è¯·æˆåŠŸè¿˜æ˜¯è¢«æ‹’ï¼ŒGender æ˜¯æ€§åˆ«è€Œ Dept è¡¨ç¤ºéƒ¨é—¨ã€‚æ¥ `as.data.frame()` çœ‹ä¸€ä¸‹ï¼š

```{r UCBAdmissions}
is_alluvia_form(as.data.frame(UCBAdmissions), axes = 1:3, silent = TRUE)

UCBAdmissions %>% 
  as.data.frame() %>% 
  head() %>% 
  knitr::kable()
```

æœç„¶ï¼Œ`as.data.frame()` ä¼šæŠŠæ•°æ®è½¬æ¢æˆåˆšåˆšä¸Šé¢æè¿°çš„å®½æ•°æ®å½¢å¼ã€‚ç„¶åè¿™ä¸ªæ•°æ®å°±å¯ä»¥ç›´æ¥æ‹¿æ¥åšå†²ç§¯å›¾äº†ã€‚

**ggalluvial** ä½œå›¾è¯­æ³•ä¹Ÿæ˜¯ä¸ **alluvial** ç›¸ä¸€è‡´çš„ï¼šç”¨æˆ·éœ€è¦æŒ‡å®š `axis` å‚æ•°ï¼Œè¿™ä¸€å‚æ•°ä¼šè¢« `stat_alluvium()` å’Œ `stat_stratum()` è¯†åˆ«å¤„ç†ï¼š

```{r geom_alluvial}
ggplot(as.data.frame(UCBAdmissions),
       aes(y = Freq, axis1 = Gender, axis2 = Dept)) +
  geom_alluvium(aes(fill = Admit), width = 1/12) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", label.strata = TRUE) +
  scale_x_discrete(limits = c("Gender", "Dept"), expand = c(.05, .05)) +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("UC Berkeley admissions and rejections, by sex and department") +
  theme_bw()
```

è¿™ä¸ªä½œå›¾ç”¨åˆ°äº†å¸¸ç”¨çš„å¾ˆå¤šè¯­å¥ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯ `geom_alluvium()` å’Œ `geom_stratum()`ï¼Œå‰è€…ç”»æ¡å¸¦ï¼Œåè€…ç”»æŸ±å­ã€‚å…¶ä»–å¯ä»¥ä¸€ä¸ªä¸€ä¸ªå»æ‰çœ‹çœ‹å›¾å½¢å‘ç”Ÿå˜åŒ–æ¥äº†è§£æ¯ä¸€ä¸ªå‚æ•°çš„ä½œç”¨ã€‚



**ggalluvial** ä½œå‡ºæ¥çš„å›¾æœ‰ä¸€ä¸ªæœ‰ç‚¹å°±æ˜¯ Y è½´æ˜¯æœ‰æ„ä¹‰çš„ã€‚Y è½´æ˜¯ä¾æ®åŸæœ¬æ•°æ®çš„å°ºåº¦è€Œæ²¡æœ‰åšä»»ä½•è½¬æ¢ç›´æ¥ç”Ÿæˆçš„ï¼Œæ•°æ®ä¸­ä¹Ÿæ²¡æœ‰é—´éš”ï¼Œæ‰€ä»¥ Y è½´ä¸Šç”»çš„æŸ±å­å®é™…ä¸Šç›¸å½“äºå †å èµ·æ¥çš„æŸ±çŠ¶å›¾ã€‚

## é•¿æ•°æ®æ ¼å¼

**ggalluvial** è¯†åˆ«çš„é•¿æ•°æ®æ ¼å¼æ˜¯ç±»ä¼¼äº **dyplr** çš„ `gather()` å¾—åˆ°çš„æ•°æ®é‚£ç§å½¢å¼ï¼Œæ¯ä¸€è¡Œéƒ½ä»£è¡¨å†²ç§¯å›¾ä¸­çš„ä¸€ä¸ªæ¡å¸¦ã€‚

```{r to_lodes_form, collapse=TRUE}
UCB_lodes <-  to_lodes_form(as.data.frame(UCBAdmissions),
                           axes = 1:3,
                           id = "Cohort")
head(UCB_lodes, n = 12)

is_lodes_form(
  UCB_lodes,
  key = x,
  value = stratum,
  id = Cohort,
  silent = TRUE)
```

è¿˜æœ‰ä¸€ä¸ª **ggalluvial** èƒ½åšçš„æ˜¯æ ¹æ®æ•°æ®ç”» `geom_flow()` å›¾ã€‚ `geom_flow()` å›¾åœ¨æ¯ä¸€ä¸ªè½´ä¸Šå¯ä»¥é‡æ–°è®¾ç½®æ•°æ®æ˜ å°„å…³ç³»ï¼Œç”¨æ¥å±•ç¤ºåŒä¸€æ•°æ®çš„å˜åŒ–ã€é‡å¤æµ‹é‡æ•°æ®ä¼šå¾ˆåˆé€‚ï¼š

```{r  geom_flow, collapse=TRUE}
data(majors)
majors$curriculum <- as.factor(majors$curriculum)
head(majors)

ggplot(majors,
       aes(x = semester,
           stratum = curriculum,
           alluvium = student,
           fill = curriculum, 
           label = curriculum)) +
  scale_fill_brewer(type = "qual", 
                    palette = "Set2") +
  geom_flow(stat = "alluvium", 
            lode.guidance = "frontback",
            color = "darkgray") +
  geom_stratum() +
  theme(legend.position = "bottom") +
  theme_minimal() +
  # title("student curricula across several semesters") +
  NULL
```

è¿™å¼ å›¾åŒæ—¶è¿˜å±•ç¤ºäº† `NA` çš„ä¸€ç§å¤„ç†åŠæ³•ï¼Œè¿˜å¯ä»¥è®¾ç½®å‚æ•° `na.rm = TRUE`ã€‚ç¼ºå¤±å€¼çš„å¤„ç†å’Œ `strata` å˜é‡æ˜¯å­—ç¬¦å‹è¿˜æ˜¯å› å­æˆ–æ•°å€¼å‹çš„æ•°æ®ç±»å‹æœ‰å…³ã€‚

é•¿æ•°æ®å½¢å¼è¿˜å…è®¸åœ¨ç›¸é‚»è½´ä¹‹é—´è¿›è¡Œåˆå¹¶ï¼Œè¿™å¯¹äºæŸ¥çœ‹æ•°æ®åœ¨ç›¸é‚»çš„ä¸¤ä¸ªè½´ä¹‹é—´çš„å˜åŒ–å¾ˆä¾¿åˆ©ï¼š

```{r vaccinations, collapse=TRUE}
data(vaccinations)
head(vaccinations)
levels(vaccinations$response) <- rev(levels(vaccinations$response))

ggplot(vaccinations,
       aes(x = survey, stratum = response, alluvium = subject,
           y = freq,
           fill = response, label = response)) +
  scale_x_discrete(expand = c(.1, .1)) +
  geom_flow() +
  geom_stratum(alpha = .5) +
  geom_text(stat = "stratum", size = 3) +
  theme(legend.position = "none") +
  ggtitle("vaccination survey responses at three points in time")
```

å—¯ï¼Œå°±è¿™äº›ã€‚**ggalluvial** èƒ½åš flow å›¾æ˜¯ä¸€ä¸ªä¼˜åŠ¿ã€‚